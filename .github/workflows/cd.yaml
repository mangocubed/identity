name: CD

on:
    release:
        types: [published]

    workflow_dispatch:

env:
    APP_TITLE: "MangoÂ³ ID"
    CARGO_TERM_COLOR: always
    DATABASE_URL: postgres://mango3:mango3@127.0.0.1:5432/identity_test

jobs:
    build_api:
        runs-on: ubuntu-24.04
        services:
            postgres:
                image: postgres:17-alpine
                env:
                    POSTGRES_USER: mango3
                    POSTGRES_PASSWORD: mango3
                    POSTGRES_DB: identity_test
                ports:
                    - 5432:5432
                options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
            - uses: actions/checkout@v6
            - uses: ./.github/actions/setup-dioxus
            - run: cargo build --package identity-api --release
            - uses: actions/upload-artifact@v5
              with:
                  name: identity_api_build
                  path: ./target/release/identity-api
                  retention-days: 1

    build_app:
        runs-on: ubuntu-24.04
        services:
            postgres:
                image: postgres:17-alpine
                env:
                    POSTGRES_USER: mango3
                    POSTGRES_PASSWORD: mango3
                    POSTGRES_DB: identity_test
                ports:
                    - 5432:5432
                options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
            - uses: actions/checkout@v6
            - uses: ./.github/actions/setup-dioxus
            - uses: ./.github/actions/setup-node
            - run: npm run build
            - run: dx bundle --package identity-app --web --release --verbose
              env:
                  APP_TOKEN: ${{ secrets.APP_TOKEN }}
            - uses: actions/upload-artifact@v5
              with:
                  name: identity_app_build
                  path: ./target/dx/identity-app/release/web/
                  retention-days: 1

    build_cli:
        runs-on: ubuntu-24.04
        services:
            postgres:
                image: postgres:17-alpine
                env:
                    POSTGRES_USER: mango3
                    POSTGRES_PASSWORD: mango3
                    POSTGRES_DB: identity_test
                ports:
                    - 5432:5432
                options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
            - uses: actions/checkout@v6
            - uses: ./.github/actions/setup-dioxus
            - run: cargo build --package identity-cli --release
            - uses: actions/upload-artifact@v5
              with:
                  name: identity_cli_build
                  path: ./target/release/identity-cli
                  retention-days: 1

    build_monitor:
        runs-on: ubuntu-24.04
        services:
            postgres:
                image: postgres:17-alpine
                env:
                    POSTGRES_USER: mango3
                    POSTGRES_PASSWORD: mango3
                    POSTGRES_DB: identity_test
                ports:
                    - 5432:5432
                options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
            - uses: actions/checkout@v6
            - uses: ./.github/actions/setup-dioxus
            - run: cargo build --package identity-monitor --release
            - uses: actions/upload-artifact@v5
              with:
                  name: identity_monitor_build
                  path: ./target/release/identity-monitor
                  retention-days: 1

    deploy:
        needs: [build_api, build_app, build_cli, build_monitor]
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v6
            - uses: actions/download-artifact@v6
              with:
                  name: identity_api_build
                  path: builds/
            - uses: actions/download-artifact@v6
              with:
                  name: identity_app_build
                  path: builds/identity-app/
            - uses: actions/download-artifact@v6
              with:
                  name: identity_cli_build
                  path: builds/
            - uses: actions/download-artifact@v6
              with:
                  name: identity_monitor_build
                  path: builds/
            - name: Run deploy script
              run: ${{ secrets.DEPLOY_SCRIPT }}
